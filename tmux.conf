set-environment -g TMUX_PLUGIN_MANAGER_PATH '~/.config/tmux/.tmux/plugins/'

# adds colors
set -g default-terminal "tmux-256color"
set-option -sa terminal-overrides ",xterm*:Tc"
set -g mouse on

# Disable pane borders to match Zellij's pane_frames false
set -g pane-border-style fg=colour238
set -g pane-active-border-style fg=colour238
set -g pane-border-status off

# run these commands to set up tpm and plugins
# git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/.tmux/plugins/tpm
# "~/.config/tmux/.tmux/plugins/tpm/bin/install_plugins"
# to update
# bind -n C-u run-shell "~/.config/tmux/.tmux/plugins/tpm/bin/update_plugins all"

# Unbind all default keybindings to mimic Zellij's clear-defaults=true
unbind-key -a

# Disable prefix to allow direct mode switching
set -g prefix None

# plug-ins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'tmux-plugins/tmux-yank'

# Add tmux-floax plugin for floating panes
set -g @plugin 'omerxx/tmux-floax'
set -g @floax-bind 'w'  # Bind to 'w' in pane mode to match Zellij's ToggleFloatingPanes
set -g @floax-bind-menu 'e'  # Bind menu to 'e' in pane mode to match Zellij's TogglePaneEmbedOrFloating
set -g @floax-width '80%'
set -g @floax-height '80%'
set -g @floax-border-color 'magenta'
set -g @floax-text-color 'blue'
set -g @floax-change-path 'true'
set -g @floax-session-name 'scratch'
set -g @floax-title 'floax'

# Keybindings for mode switching (no prefix, matching Zellij)
bind -n C-a switch-client -T pane \; refresh-client -S
bind -n C-t switch-client -T tab \; refresh-client -S
bind -n C-s switch-client -T scroll \; refresh-client -S
bind -n C-z switch-client -T session \; refresh-client -S
bind -n M-r switch-client -T renametab \; refresh-client -S
bind -n C-g switch-client -T locked \; refresh-client -S
bind -n C-i run-shell "~/.config/tmux/.tmux/plugins/tpm/bin/install_plugins"  # Install plugins

# Dynamic status bar content per mode (via shell script)
set -g status-right-length 85
set -g status-right '#[fg=colour136,bg=colour235] #[fg=colour235,bg=colour136] #(~/.config/tmux/status-mode.sh)'

# Locked mode
bind -T locked C-g switch-client -T root \; refresh-client -S

# Resize mode
bind -n C-n switch-client -T resize \; refresh-client -S
bind -T resize C-n switch-client -T root \; refresh-client -S
bind -T resize h resize-pane -L 5
bind -T resize j resize-pane -D 5
bind -T resize k resize-pane -U 5
bind -T resize l resize-pane -R 5
bind -T resize H resize-pane -R 5  # Decrease left = increase right
bind -T resize J resize-pane -U 5  # Decrease down = increase up
bind -T resize K resize-pane -D 5  # Decrease up = increase down
bind -T resize L resize-pane -L 5  # Decrease right = increase left
bind -T resize = resize-pane -Z
bind -T resize - resize-pane -Z

# Pane mode
bind -T pane C-a switch-client -T root \; refresh-client -S
bind -T pane h select-pane -L
bind -T pane l select-pane -R
bind -T pane j select-pane -D
bind -T pane k select-pane -U
bind -T pane p select-pane -l
bind -T pane n split-window -h
bind -T pane d split-window -v
bind -T pane x kill-pane
bind -T pane z resize-pane -Z
bind -T pane f run-shell "tmux set -g pane-border-status top \; tmux set -g pane-border-format '#{pane_title}'"
bind -T pane w run-shell "tmux popup -E -w 80% -h 80% 'tmux attach -t scratch || tmux new -s scratch'"
bind -T pane e run-shell "tmux popup -E -w 80% -h 80% 'tmux attach -t scratch || tmux new -s scratch'"
bind -T pane r command-prompt -p "Pane name:" "select-pane -T '%%'"

# Tab mode (tmux windows)
bind -T tab C-t switch-client -T root \; refresh-client -S
bind -T tab r command-prompt -p "Window name:" "rename-window '%%'"
bind -T tab h previous-window
bind -T tab l next-window
bind -T tab k previous-window
bind -T tab j next-window
bind -T tab n new-window
bind -T tab x kill-window
bind -T tab s run-shell "tmux display-message 'Sync not supported in tmux'"
bind -T tab b break-pane
bind -T tab ] break-pane
bind -T tab [ break-pane
bind -T tab 1 select-window -t 1
bind -T tab 2 select-window -t 2
bind -T tab 3 select-window -t 3
bind -T tab 4 select-window -t 4
bind -T tab 5 select-window -t 5
bind -T tab 6 select-window -t 6
bind -T tab 7 select-window -t 7
bind -T tab 8 select-window -t 8
bind -T tab 9 select-window -t 9
bind -T tab a select-window -l

# Scroll mode
bind -T scroll C-s switch-client -T root \; refresh-client -S
bind -T scroll e run-shell "tmux save-buffer /tmp/tmux-buffer && nvim /tmp/tmux-buffer"
bind -T scroll s command-prompt -p "Search:" "send-keys -X search-forward '%%'" \; switch-client -T search \; refresh-client -S
bind -T scroll G send-keys -X bottom-line
bind -T scroll j send-keys -X cursor-down
bind -T scroll k send-keys -X cursor-up
bind -T scroll C-f send-keys -X page-down
bind -T scroll C-b send-keys -X page-up
bind -T scroll d send-keys -X halfpage-down
bind -T scroll u send-keys -X halfpage-up

# Search mode
bind -T scroll C-/ switch-client -T search \; refresh-client -S
bind -T search C-/ switch-client -T root \; refresh-client -S
bind -T search j send-keys -X cursor-down
bind -T search k send-keys -X cursor-up
bind -T search C-f send-keys -X page-down
bind -T search C-b send-keys -X page-up
bind -T search d send-keys -X halfpage-down
bind -T search u send-keys -X halfpage-up
bind -T search n send-keys -X search-again
bind -T search p send-keys -X search-reverse
bind -T search c run-shell "tmux display-message 'Case sensitivity toggle not supported'"
bind -T search w run-shell "tmux display-message 'Wrap toggle not supported'"
bind -T search o run-shell "tmux display-message 'Whole word toggle not supported'"

# Entersearch mode
bind -T scroll Enter command-prompt -p "Search:" "send-keys -X search-forward '%%'" \; switch-client -T search \; refresh-client -S

# Renametab mode
bind -T renametab C-c switch-client -T root \; refresh-client -S
bind -T renametab Escape command-prompt -p "Window name:" "rename-window '%%'"

# Renamepane mode (integrated into pane r binding, but cancel via C-c/Escape)
bind -T pane C-c switch-client -T root \; refresh-client -S
bind -T pane Escape command-prompt -p "Pane name:" "select-pane -T '%%'"

# Session mode
bind -T session C-z switch-client -T root \; refresh-client -S
bind -T session d detach-client
bind -T session w run-shell "tmux choose-tree -Zw"

# Shared keybindings
bind -n M-n split-window -h
bind -n C-h select-pane -L
bind -n C-l select-pane -R
bind -n C-j select-pane -D
bind -n C-k select-pane -U
bind -n C-= resize-pane -Z
bind -n C-- resize-pane -Z
bind -n M-[ previous-layout
bind -n M-] next-layout


# Status bar configuration (base settings, manual colors)
set -g status on
set -g status-position top
set -g status-style bg=colour235,fg=colour136
set -g status-left "#[fg=colour136,bg=colour235] #S #[fg=colour235,bg=colour136]"
set -g window-status-format "#[fg=colour244,bg=colour235] #I:#W "
set -g window-status-current-format "#[fg=colour235,bg=colour136] #[fg=colour235,bg=colour136] #I:#W #[fg=colour136,bg=colour235]"
set -g status-justify left
set -g status-interval 1
set -g status-left-length 0

# start tmux index at 1
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1
set-option -g renumber-windows on
set -g allow-rename off
set -g automatic-rename off
set -g focus-events on
set -g detach-on-destroy on
set -g escape-time 0

# shift alt vim keys to switch windows
bind -n M-H previous-window
bind -n M-L next-window

# set vi mode
set-window-option -g mode-keys vi

# copy keybindings
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# open new panes in cwd
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

run '~/.config/tmux/.tmux/plugins/tpm/tpm'
